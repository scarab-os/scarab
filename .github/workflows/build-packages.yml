name: Build Packages

on:
  push:
    branches: [main]
    paths: ['ports/**', 'scripts/build-package.sh']
  workflow_dispatch:

env:
  TARGET: x86_64-scarab-linux-musl
  TOOLCHAIN_URL: https://github.com/scarab-os/toolchain/releases/download/latest/toolchain-x86_64.tar.zst

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: scan
        name: Discover ports
        run: |
          # Scan all ports, skip special ones (kernel, libc, bootloader, init)
          SKIP="linux musl limine nitro"
          
          matrix="["
          first=true
          for portfile in ports/*/*/Portfile; do
            cat=$(echo "$portfile" | cut -d/ -f2)
            name=$(echo "$portfile" | cut -d/ -f3)
            ver=$(grep "^version=" "$portfile" | cut -d= -f2)
            
            # Skip special packages
            echo "$SKIP" | grep -qw "$name" && continue
            
            [ "$first" = true ] && first=false || matrix="$matrix,"
            matrix="$matrix{\"name\":\"$name\",\"version\":\"$ver\",\"category\":\"$cat\"}"
          done
          matrix="$matrix]"
          
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
          echo "Found $(echo "$matrix" | grep -o '"name"' | wc -l) packages"

  build:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake meson ninja-build \
            bc flex bison libelf-dev zstd pkg-config

      - name: Download toolchain
        run: |
          curl -fL "$TOOLCHAIN_URL" | zstd -d | tar xf -
          echo "$PWD/toolchain/bin" >> $GITHUB_PATH

      - name: Build ${{ matrix.package.name }}
        run: |
          chmod +x scripts/build-package.sh
          
          export CROSS="${TARGET}"
          export SYSROOT="$PWD/toolchain/${TARGET}"
          
          scripts/build-package.sh \
            "${{ matrix.package.category }}" \
            "${{ matrix.package.name }}" \
            "$PWD"

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.package.name }}
          path: |
            *.tar.gz
            *.sha256

  publish:
    needs: build
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: pkg-*
          merge-multiple: false

      - name: Generate repo.json
        run: |
          python3 << 'EOF'
          import json, os, glob
          
          packages = []
          for d in sorted(glob.glob('artifacts/pkg-*/')):
              for tarball in glob.glob(os.path.join(d, '*.tar.gz')):
                  if tarball.endswith('.sha256'): continue
                  filename = os.path.basename(tarball)
                  base = filename.replace('-x86_64.tar.gz', '')
                  parts = base.rsplit('-', 1)
                  name, version = (parts[0], parts[1]) if len(parts) > 1 else (base, '?')
                  
                  sha_file = tarball + '.sha256'
                  sha256 = open(sha_file).read().split()[0] if os.path.exists(sha_file) else ''
                  size = f'{os.path.getsize(tarball)/1024/1024:.1f}M'
                  
                  category = desc = ''
                  deps = []
                  for cat in ['core','lib','devel','net','extra']:
                      pf = f'ports/{cat}/{name}/Portfile'
                      if os.path.exists(pf):
                          category = cat
                          for line in open(pf):
                              if line.startswith('# Description:'): desc = line.split(':',1)[1].strip()
                              elif line.startswith('# Depends:'):
                                  d = line.split(':',1)[1].strip()
                                  if d: deps = d.split()
                          break
                  
                  packages.append(dict(name=name, version=version, category=category,
                      description=desc, depends=deps, size=size, sha256=sha256, filename=filename))
          
          with open('repo.json','w') as f: json.dump(packages, f, indent=2)
          print(f'{len(packages)} packages in repo.json')
          EOF
          cat repo.json

      - name: Publish to packages repo
        uses: softprops/action-gh-release@v2
        with:
          repository: scarab-os/packages
          tag_name: latest
          name: "Package Repository"
          body: "Automatically built packages for Scarab OS"
          files: |
            repo.json
            artifacts/pkg-*/*.tar.gz
            artifacts/pkg-*/*.sha256
          token: ${{ secrets.PACKAGES_TOKEN }}
