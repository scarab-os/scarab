name: Build Packages

on:
  push:
    branches: [main]
    paths: ['ports/**']
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to build (comma-separated, or "all")'
        required: false
        default: 'all'

env:
  TARGET: x86_64-scarab-linux-musl
  ARCH: x86_64

jobs:
  toolchain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bison flex texinfo \
            libgmp-dev libmpfr-dev libmpc-dev xorriso mtools bc \
            libelf-dev nasm curl

      - name: Cache toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: toolchain
          key: toolchain-musl-${{ hashFiles('scripts/build-toolchain.sh') }}

      - name: Build toolchain
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        run: bash scripts/build-toolchain.sh ./toolchain

      - name: Test toolchain
        run: |
          export PATH="$PWD/toolchain/bin:$PATH"
          echo '#include <stdio.h>
          int main() { return 0; }' | ${TARGET}-gcc -x c - -o /dev/null
          echo "Toolchain OK"

      - name: Upload toolchain
        uses: actions/upload-artifact@v4
        with:
          name: toolchain
          path: toolchain
          retention-days: 7

  packages:
    needs: toolchain
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - { name: busybox, version: "1.37.0", category: core }
          - { name: zlib, version: "1.3.1", category: core }
          - { name: mbedtls, version: "3.6.5", category: core }
          - { name: musl, version: "1.2.5", category: core }
          - { name: curl, version: "8.18.0", category: core }
          - { name: e2fsprogs, version: "1.47.3", category: core }
          - { name: ncurses, version: "6.6", category: lib }
          - { name: dropbear, version: "2025.89", category: net }
          - { name: dhcpcd, version: "10.3.0", category: net }
          - { name: iproute2, version: "6.12.0", category: net }
          - { name: nano, version: "8.7", category: extra }
          - { name: htop, version: "3.4.1", category: extra }
          - { name: make, version: "4.4.1", category: devel }
          - { name: bash, version: "5.2.37", category: devel }
          - { name: bison, version: "3.8.2", category: devel }
          - { name: flex, version: "2.6.4", category: devel }
          - { name: ninja, version: "1.13.2", category: devel }
          - { name: git, version: "2.53.0", category: devel }
          - { name: cmake, version: "4.2.3", category: devel }
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake meson ninja-build \
            bc flex bison libelf-dev

      - name: Download toolchain
        uses: actions/download-artifact@v4
        with:
          name: toolchain
          path: toolchain

      - name: Fix toolchain permissions
        run: chmod -R +x toolchain/bin/

      - name: Build ${{ matrix.package.name }}
        run: |
          export PATH="$PWD/toolchain/bin:$PATH"
          export CROSS=${{ env.TARGET }}
          export SYSROOT="$PWD/toolchain/${{ env.TARGET }}"
          
          PKG_NAME="${{ matrix.package.name }}"
          PKG_VER="${{ matrix.package.version }}"
          PKG_DIR="pkg-output"
          
          mkdir -p build-work "$PKG_DIR"
          
          # Source the Portfile and build
          cd build-work
          source "../ports/${{ matrix.package.category }}/${PKG_NAME}/Portfile" 2>/dev/null || true
          
          # Download source
          if [ -n "$source" ]; then
            curl -fL -o "$(basename "$source")" "$source"
            case "$(basename "$source")" in
              *.tar.gz|*.tgz) tar xzf "$(basename "$source")" ;;
              *.tar.xz) tar xJf "$(basename "$source")" ;;
              *.tar.bz2) tar xjf "$(basename "$source")" ;;
            esac
          fi
          
          # Apply patches
          PORTDIR="../ports/${{ matrix.package.category }}/${PKG_NAME}"
          if [ -d "$PORTDIR/patches" ]; then
            for p in "$PORTDIR/patches"/*.patch; do
              [ -f "$p" ] && patch -p1 < "$p"
            done
          fi
          
          # Build
          export PKG="$PWD/../$PKG_DIR"
          export SRC="$PWD"
          export MAKEFLAGS="-j$(nproc)"
          build || echo "Build needs custom handling"
          
          cd ..
          
          # Create tarball
          TARBALL="${PKG_NAME}-${PKG_VER}-${{ env.ARCH }}.tar.gz"
          if [ "$(ls -A "$PKG_DIR" 2>/dev/null)" ]; then
            cd "$PKG_DIR"
            tar czf "../$TARBALL" .
            cd ..
            sha256sum "$TARBALL" > "${TARBALL}.sha256"
            echo "Built: $TARBALL ($(du -h "$TARBALL" | cut -f1))"
          else
            echo "Warning: empty package output for $PKG_NAME"
          fi

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.package.name }}
          path: |
            *.tar.gz
            *.sha256
          if-no-files-found: warn

  repo-db:
    needs: packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: pkg-*

      - name: Generate repo.json
        run: |
          echo "[" > repo.json
          first=true
          for dir in artifacts/pkg-*/; do
            for tarball in "$dir"*.tar.gz; do
              [ -f "$tarball" ] || continue
              filename=$(basename "$tarball")
              name=$(echo "$filename" | sed 's/-[0-9].*//')
              version=$(echo "$filename" | sed "s/${name}-//" | sed 's/-x86_64.tar.gz//')
              sha256=$(cat "${tarball}.sha256" 2>/dev/null | awk '{print $1}')
              size=$(du -h "$tarball" | cut -f1)
              
              # Get metadata from Portfile
              category=""
              desc=""
              deps=""
              for cat in core lib devel net extra; do
                pf="ports/$cat/$name/Portfile"
                if [ -f "$pf" ]; then
                  category="$cat"
                  desc=$(grep "^# Description:" "$pf" | sed 's/# Description: //')
                  deps=$(grep "^# Depends:" "$pf" | sed 's/# Depends: //')
                  break
                fi
              done
              
              if [ "$first" = true ]; then first=false; else echo "," >> repo.json; fi
              
              deps_json="[]"
              if [ -n "$deps" ]; then
                deps_json=$(echo "$deps" | tr ' ' '\n' | sed 's/.*/"&"/' | tr '\n' ',' | sed 's/,$//' | sed 's/^/[/' | sed 's/$/]/')
              fi
              
              cat >> repo.json <<ENTRY
            {
              "name": "$name",
              "version": "$version",
              "category": "$category",
              "description": "$desc",
              "depends": $deps_json,
              "size": "$size",
              "sha256": "$sha256",
              "filename": "$filename"
            }
          ENTRY
            done
          done
          echo "]" >> repo.json
          
          echo "Generated repo.json:"
          cat repo.json | head -30

      - name: Upload repo.json
        uses: actions/upload-artifact@v4
        with:
          name: repo-db
          path: repo.json

  iso:
    needs: packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso cpio gzip bc libelf-dev \
            build-essential flex bison qemu-system-x86

      - name: Download toolchain
        uses: actions/download-artifact@v4
        with:
          name: toolchain
          path: toolchain

      - name: Fix toolchain permissions
        run: chmod -R +x toolchain/bin/

      - name: Build rootfs + ISO
        run: |
          export PATH="$PWD/toolchain/bin:$HOME/bin:$PATH"
          
          # Build rootfs
          bash scripts/build-rootfs.sh ./rootfs
          
          # Build kernel
          cd toolchain-build/src/linux-* 2>/dev/null || {
            mkdir -p build-kernel && cd build-kernel
            curl -fL "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.73.tar.xz" | tar xJ
            cd linux-6.12.73
          }
          make ARCH=x86_64 CROSS_COMPILE=x86_64-scarab-linux-musl- defconfig
          make ARCH=x86_64 CROSS_COMPILE=x86_64-scarab-linux-musl- -j$(nproc)
          mkdir -p ../../rootfs/boot
          cp arch/x86/boot/bzImage ../../rootfs/boot/vmlinuz-6.12.73
          cd ../..
          
          # Install packages from artifacts
          # (simplified - in real CI we'd extract all package tarballs)
          
          # Create ISO with Limine
          bash scripts/build-iso.sh ./rootfs || echo "ISO build needs Limine setup"

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: scarab-iso
          path: "*.iso"
          if-no-files-found: warn

  publish:
    needs: [repo-db, packages]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release
          cp artifacts/repo-db/repo.json release/
          for dir in artifacts/pkg-*/; do
            cp "$dir"*.tar.gz "$dir"*.sha256 release/ 2>/dev/null || true
          done
          ls -lh release/

      - name: Publish to packages repo
        uses: softprops/action-gh-release@v2
        with:
          repository: scarab-os/packages
          tag_name: latest
          name: "Package Repository"
          body: "Automatically built packages for Scarab OS"
          files: release/*
          token: ${{ secrets.PACKAGES_TOKEN }}
