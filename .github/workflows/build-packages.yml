name: Build Packages

on:
  push:
    branches: [main]
    paths: ['ports/**']
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to build (comma-separated, or "all")'
        required: false
        default: 'all'

env:
  TARGET: x86_64-scarab-linux-musl
  ARCH: x86_64
  TOOLCHAIN_URL: https://github.com/scarab-os/toolchain/releases/download/latest/toolchain-x86_64.tar.zst

jobs:
  toolchain:
    runs-on: ubuntu-latest
    steps:
      - name: Download prebuilt toolchain
        run: |
          curl -fL "$TOOLCHAIN_URL" | zstd -d | tar xf -
          echo "Toolchain downloaded"
          ls toolchain/bin/${TARGET}-gcc

      - name: Test toolchain
        run: |
          export PATH="$PWD/toolchain/bin:$PATH"
          echo '#include <stdio.h>
          int main() { return 0; }' | ${TARGET}-gcc -x c - -o /dev/null
          echo "Toolchain OK"

      - name: Upload toolchain
        uses: actions/upload-artifact@v4
        with:
          name: toolchain
          path: toolchain
          retention-days: 1

  packages:
    needs: toolchain
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - { name: busybox, version: "1.37.0", category: core }
          - { name: zlib, version: "1.3.1", category: core }
          - { name: mbedtls, version: "3.6.5", category: core }
          - { name: curl, version: "8.18.0", category: core }
          - { name: e2fsprogs, version: "1.47.3", category: core }
          - { name: ncurses, version: "6.6", category: lib }
          - { name: dropbear, version: "2025.89", category: net }
          - { name: dhcpcd, version: "10.3.0", category: net }
          - { name: iproute2, version: "6.12.0", category: net }
          - { name: nano, version: "8.7", category: extra }
          - { name: htop, version: "3.4.1", category: extra }
          - { name: make, version: "4.4.1", category: devel }
          - { name: bash, version: "5.2.37", category: devel }
          - { name: bison, version: "3.8.2", category: devel }
          - { name: flex, version: "2.6.4", category: devel }
          - { name: ninja, version: "1.13.2", category: devel }
          - { name: git, version: "2.53.0", category: devel }
          - { name: cmake, version: "4.2.3", category: devel }
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake meson ninja-build \
            bc flex bison libelf-dev zstd

      - name: Download toolchain
        uses: actions/download-artifact@v4
        with:
          name: toolchain
          path: toolchain

      - name: Fix toolchain permissions
        run: chmod -R +x toolchain/bin/

      - name: Build ${{ matrix.package.name }}
        run: |
          export PATH="$PWD/toolchain/bin:$PATH"
          export CROSS="${{ env.TARGET }}"
          export SYSROOT="$PWD/toolchain/${{ env.TARGET }}"
          
          PKG_NAME="${{ matrix.package.name }}"
          PKG_VER="${{ matrix.package.version }}"
          PKG_DIR="$PWD/pkg-output"
          WORK="$PWD/build-work"
          
          mkdir -p "$WORK" "$PKG_DIR"
          
          # Source the Portfile
          PORTFILE="ports/${{ matrix.package.category }}/${PKG_NAME}/Portfile"
          . "$PORTFILE" 2>/dev/null || true
          
          # Download source
          if [ -n "$source" ]; then
            cd "$WORK"
            curl -fL -o "$(basename "$source")" "$source"
            case "$(basename "$source")" in
              *.tar.gz|*.tgz) tar xzf "$(basename "$source")" ;;
              *.tar.xz) tar xJf "$(basename "$source")" ;;
              *.tar.bz2) tar xjf "$(basename "$source")" ;;
            esac
          fi
          
          # Apply patches
          PORTDIR="$GITHUB_WORKSPACE/ports/${{ matrix.package.category }}/${PKG_NAME}"
          if [ -d "$PORTDIR/patches" ]; then
            for p in "$PORTDIR/patches"/*.patch; do
              [ -f "$p" ] && patch -d "$WORK" -p1 < "$p"
            done
          fi
          
          # Build
          export PKG="$PKG_DIR"
          export SRC="$WORK"
          export MAKEFLAGS="-j$(nproc)"
          cd "$WORK"
          build || echo "::warning::Build function failed for $PKG_NAME"
          
          cd "$GITHUB_WORKSPACE"
          
          # Create tarball
          TARBALL="${PKG_NAME}-${PKG_VER}-${{ env.ARCH }}.tar.gz"
          if [ "$(ls -A "$PKG_DIR" 2>/dev/null)" ]; then
            cd "$PKG_DIR"
            tar czf "$GITHUB_WORKSPACE/$TARBALL" .
            cd "$GITHUB_WORKSPACE"
            sha256sum "$TARBALL" > "${TARBALL}.sha256"
            echo "âœ… Built: $TARBALL ($(du -h "$TARBALL" | cut -f1))"
          else
            echo "::warning::Empty package output for $PKG_NAME"
          fi

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.package.name }}
          path: |
            *.tar.gz
            *.sha256
          if-no-files-found: warn

  repo-db:
    needs: packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: pkg-*

      - name: Generate repo.json
        run: |
          python3 -c "
          import json, os, glob

          packages = []
          for d in sorted(glob.glob('artifacts/pkg-*/')):
              for tarball in glob.glob(os.path.join(d, '*.tar.gz')):
                  if tarball.endswith('.sha256'):
                      continue
                  filename = os.path.basename(tarball)
                  parts = filename.replace('-x86_64.tar.gz', '').rsplit('-', 1)
                  name = parts[0]
                  version = parts[1] if len(parts) > 1 else 'unknown'
                  
                  sha_file = tarball + '.sha256'
                  sha256 = ''
                  if os.path.exists(sha_file):
                      sha256 = open(sha_file).read().split()[0]
                  
                  size = f'{os.path.getsize(tarball) / 1024 / 1024:.1f}M'
                  
                  # Get metadata from Portfile
                  category = desc = ''
                  deps = []
                  for cat in ['core', 'lib', 'devel', 'net', 'extra']:
                      pf = f'ports/{cat}/{name}/Portfile'
                      if os.path.exists(pf):
                          category = cat
                          for line in open(pf):
                              if line.startswith('# Description:'):
                                  desc = line.split(':', 1)[1].strip()
                              elif line.startswith('# Depends:'):
                                  deps = line.split(':', 1)[1].strip().split()
                          break
                  
                  packages.append({
                      'name': name,
                      'version': version,
                      'category': category,
                      'description': desc,
                      'depends': deps,
                      'size': size,
                      'sha256': sha256,
                      'filename': filename
                  })

          with open('repo.json', 'w') as f:
              json.dump(packages, f, indent=2)
          print(f'Generated repo.json with {len(packages)} packages')
          "
          cat repo.json

      - name: Upload repo.json
        uses: actions/upload-artifact@v4
        with:
          name: repo-db
          path: repo.json

  publish:
    needs: [repo-db, packages]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release
          cp artifacts/repo-db/repo.json release/
          for dir in artifacts/pkg-*/; do
            cp "$dir"*.tar.gz "$dir"*.sha256 release/ 2>/dev/null || true
          done
          echo "Release files:"
          ls -lh release/

      - name: Publish to packages repo
        uses: softprops/action-gh-release@v2
        with:
          repository: scarab-os/packages
          tag_name: latest
          name: "Package Repository"
          body: "Automatically built packages for Scarab OS"
          files: release/*
          token: ${{ secrets.PACKAGES_TOKEN }}
