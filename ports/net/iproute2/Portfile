# Description: IP routing utilities
# URL: https://wiki.linuxfoundation.org/networking/iproute2
# Depends:

name=iproute2
version=6.18.0
source=https://git.kernel.org/pub/scm/network/iproute2/iproute2.git/snapshot/iproute2-$version.tar.gz

build() {
    cd $name-$version
    sed -i '1i #include <limits.h>' lib/utils_math.c
    sed -i '/static.*setns/d' include/namespace.h
    sed -i '1i #include <endian.h>' include/libnetlink.h
    sed -i '1i #include <linux/limits.h>' ip/iplink.c
    CC=$CC PKG_CONFIG=false ./configure
    CONF_COLOR=$(grep "^CONF_COLOR" config.mk | cut -d= -f2)
    make CC=$CC AR=$AR \
        CFLAGS="-Os -D_GNU_SOURCE -I../include -DHAVE_SETNS -DCONF_COLOR=${CONF_COLOR} -DHAVE_HANDLE_AT" \
        LDFLAGS="-static" SUBDIRS="lib ip bridge" -j$(nproc)
    mkdir -p $PKG/sbin
    cp ip/ip bridge/bridge $PKG/sbin/
}
