# Description: Cross-platform build system
# URL: https://cmake.org
# Depends:

name=cmake
version=4.2.3
source=https://github.com/Kitware/CMake/releases/download/v$version/cmake-$version.tar.gz

build() {
    cd $name-$version
    mkdir bld-host && cd bld-host
    cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF \
        -DCMAKE_USE_OPENSSL=OFF
    make -j$(nproc)
    HOST_CMAKE="$(pwd)/bin/cmake"
    cd ..
    mkdir bld-cross && cd bld-cross
    cat > tc.cmake <<TCEOF
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR x86_64)
set(CMAKE_C_COMPILER $CC)
set(CMAKE_CXX_COMPILER $CXX)
set(CMAKE_FIND_ROOT_PATH $SYSROOT)
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
set(CMAKE_EXE_LINKER_FLAGS "-static")
set(HAVE_POSIX_STRERROR_R 1)
TCEOF
    $HOST_CMAKE .. -DCMAKE_TOOLCHAIN_FILE=tc.cmake \
        -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_TESTING=OFF -DCMAKE_USE_OPENSSL=OFF
    make -j$(nproc)
    make DESTDIR=$PKG install
}
